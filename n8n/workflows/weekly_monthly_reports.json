{
    "name": "VittaSaathi - Weekly & Monthly Reports",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "triggerAtHour": 20,
                            "daysInterval": 7
                        }
                    ]
                }
            },
            "id": "weekly-trigger",
            "name": "Weekly (Sunday 8PM)",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                200,
                200
            ]
        },
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "triggerAtHour": 20,
                            "triggerAtDayOfMonth": 1
                        }
                    ]
                }
            },
            "id": "monthly-trigger",
            "name": "Monthly (1st, 8PM)",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                200,
                400
            ]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "http://127.0.0.1:8000/users",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "get-users-weekly",
            "name": "Get Users (Weekly)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                420,
                200
            ]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "http://127.0.0.1:8000/users",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "get-users-monthly",
            "name": "Get Users (Monthly)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                420,
                400
            ]
        },
        {
            "parameters": {
                "jsCode": "const users = $input.item.json.users || $input.item.json || [];\nconst activeUsers = users.filter(u => u.onboarding_complete && u.phone);\n\nconst results = [];\nfor (const user of activeUsers) {\n  results.push({\n    phone: user.phone,\n    name: user.name || 'Friend',\n    language: user.preferred_language || 'english',\n    reportType: 'weekly'\n  });\n}\nreturn results;"
            },
            "id": "prep-weekly-users",
            "name": "Prep Weekly",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                640,
                200
            ]
        },
        {
            "parameters": {
                "jsCode": "const users = $input.item.json.users || $input.item.json || [];\nconst activeUsers = users.filter(u => u.onboarding_complete && u.phone);\n\nconst results = [];\nfor (const user of activeUsers) {\n  results.push({\n    phone: user.phone,\n    name: user.name || 'Friend',\n    language: user.preferred_language || 'english',\n    reportType: 'monthly'\n  });\n}\nreturn results;"
            },
            "id": "prep-monthly-users",
            "name": "Prep Monthly",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                640,
                400
            ]
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "id": "loop-weekly",
            "name": "Loop Weekly",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                860,
                200
            ]
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "id": "loop-monthly",
            "name": "Loop Monthly",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                860,
                400
            ]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "=http://127.0.0.1:8000/reports/{{ $json.phone }}/weekly-comparison",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "get-weekly-report",
            "name": "Get Weekly Report",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1080,
                200
            ],
            "onError": "continueRegularOutput"
        },
        {
            "parameters": {
                "method": "GET",
                "url": "=http://127.0.0.1:8000/reports/{{ $json.phone }}/monthly-comparison",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "get-monthly-report",
            "name": "Get Monthly Report",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1080,
                400
            ],
            "onError": "continueRegularOutput"
        },
        {
            "parameters": {
                "jsCode": "const report = $input.item.json;\nconst userData = $('Loop Weekly').item.json;\nconst phone = userData.phone;\nconst name = userData.name;\nconst lang = userData.language;\n\n// Build comparison message\nconst thisWeek = report.this_week || {};\nconst lastWeek = report.last_week || {};\nconst categories = report.categories || {};\n\nconst income = thisWeek.income || 0;\nconst expense = thisWeek.expense || 0;\nconst savings = income - expense;\n\nconst lastIncome = lastWeek.income || 0;\nconst lastExpense = lastWeek.expense || 0;\n\n// Calculate changes\nconst incomeChange = lastIncome > 0 ? Math.round(((income - lastIncome) / lastIncome) * 100) : 0;\nconst expenseChange = lastExpense > 0 ? Math.round(((expense - lastExpense) / lastExpense) * 100) : 0;\n\nconst incomeArrow = incomeChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';\nconst expenseArrow = expenseChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';\nconst incomeStatus = incomeChange >= 0 ? `+${incomeChange}%` : `${incomeChange}%`;\nconst expenseStatus = expenseChange <= 0 ? 'âœ… Great!' : `âš ï¸ +${expenseChange}%`;\n\n// Category breakdown\nlet categoryLines = '';\nfor (const [cat, amount] of Object.entries(categories)) {\n  categoryLines += `â€¢ ${cat}: â‚¹${amount.toLocaleString()}\\n`;\n}\n\nlet message = '';\nif (lang === 'hindi') {\n  message = `ğŸ“Š *à¤¸à¤ªà¥à¤¤à¤¾à¤¹à¤¿à¤• à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ - ${name}*\\n\\n` +\n    `ğŸ’° à¤†à¤¯: â‚¹${income.toLocaleString()} ${incomeArrow} ${incomeStatus}\\n` +\n    `ğŸ’¸ à¤–à¤°à¥à¤š: â‚¹${expense.toLocaleString()} ${expenseArrow} ${expenseStatus}\\n` +\n    `ğŸ’¾ à¤¬à¤šà¤¤: â‚¹${savings.toLocaleString()}\\n\\n` +\n    `ğŸ“‚ *à¤¶à¥à¤°à¥‡à¤£à¥€ à¤µà¤¿à¤­à¤¾à¤œà¤¨:*\\n${categoryLines || 'â€¢ à¤•à¥‹à¤ˆ à¤¡à¥‡à¤Ÿà¤¾ à¤¨à¤¹à¥€à¤‚'}\\n\\n` +\n    `ğŸ’¡ à¤…à¤—à¤²à¥‡ à¤¹à¤«à¥à¤¤à¥‡ à¤”à¤° à¤¬à¥‡à¤¹à¤¤à¤° à¤•à¤°à¥‡à¤‚!`;\n} else {\n  message = `ğŸ“Š *Weekly Report - ${name}*\\n\\n` +\n    `ğŸ’° Income: â‚¹${income.toLocaleString()} ${incomeArrow} ${incomeStatus}\\n` +\n    `ğŸ’¸ Expenses: â‚¹${expense.toLocaleString()} ${expenseArrow} ${expenseStatus}\\n` +\n    `ğŸ’¾ Savings: â‚¹${savings.toLocaleString()}\\n\\n` +\n    `ğŸ“‚ *Category Breakdown:*\\n${categoryLines || 'â€¢ No data'}\\n\\n` +\n    `ğŸ’¡ Keep improving next week!`;\n}\n\nreturn { phone, message };"
            },
            "id": "format-weekly",
            "name": "Format Weekly Report",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1300,
                200
            ]
        },
        {
            "parameters": {
                "jsCode": "const report = $input.item.json;\nconst userData = $('Loop Monthly').item.json;\nconst phone = userData.phone;\nconst name = userData.name;\nconst lang = userData.language;\n\n// Build comparison message\nconst thisMonth = report.this_month || {};\nconst lastMonth = report.last_month || {};\nconst categories = report.categories || {};\nconst goals = report.goals_progress || {};\n\nconst income = thisMonth.income || 0;\nconst expense = thisMonth.expense || 0;\nconst savings = income - expense;\nconst savingsTarget = thisMonth.savings_target || savings;\nconst savingsPercent = savingsTarget > 0 ? Math.round((savings / savingsTarget) * 100) : 0;\n\nconst lastIncome = lastMonth.income || 0;\nconst lastExpense = lastMonth.expense || 0;\n\nconst incomeChange = lastIncome > 0 ? Math.round(((income - lastIncome) / lastIncome) * 100) : 0;\nconst expenseChange = lastExpense > 0 ? Math.round(((expense - lastExpense) / lastExpense) * 100) : 0;\n\n// Category breakdown\nlet categoryLines = '';\nfor (const [cat, amount] of Object.entries(categories)) {\n  const percent = income > 0 ? Math.round((amount / income) * 100) : 0;\n  categoryLines += `â€¢ ${cat}: â‚¹${amount.toLocaleString()} (${percent}%)\\n`;\n}\n\n// Goals progress\nlet goalsLines = '';\nfor (const [goal, progress] of Object.entries(goals)) {\n  goalsLines += `â€¢ ${goal}: ${progress}%\\n`;\n}\n\nconst incomeArrow = incomeChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';\nconst expenseArrow = expenseChange <= 0 ? 'âœ…' : 'âš ï¸';\n\nlet message = '';\nif (lang === 'hindi') {\n  message = `ğŸ“Š *à¤®à¤¾à¤¸à¤¿à¤• à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ - ${name}*\\n\\n` +\n    `ğŸ’° à¤†à¤¯: â‚¹${income.toLocaleString()} ${incomeArrow} ${incomeChange >= 0 ? '+' : ''}${incomeChange}%\\n` +\n    `ğŸ’¸ à¤–à¤°à¥à¤š: â‚¹${expense.toLocaleString()} ${expenseArrow} ${expenseChange <= 0 ? 'âœ…' : '+' + expenseChange + '%'}\\n` +\n    `ğŸ’¾ à¤¬à¤šà¤¤: â‚¹${savings.toLocaleString()} (à¤²à¤•à¥à¤·à¥à¤¯ à¤•à¤¾ ${savingsPercent}%)\\n\\n` +\n    `ğŸ“‚ *à¤–à¤°à¥à¤š à¤µà¤¿à¤­à¤¾à¤œà¤¨:*\\n${categoryLines || 'â€¢ à¤•à¥‹à¤ˆ à¤¡à¥‡à¤Ÿà¤¾ à¤¨à¤¹à¥€à¤‚'}\\n` +\n    `ğŸ¯ *à¤²à¤•à¥à¤·à¥à¤¯ à¤ªà¥à¤°à¤—à¤¤à¤¿:*\\n${goalsLines || 'â€¢ à¤•à¥‹à¤ˆ à¤²à¤•à¥à¤·à¥à¤¯ à¤¨à¤¹à¥€à¤‚'}\\n` +\n    `ğŸ’ª à¤¨à¤ à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¥€ à¤¶à¥à¤­à¤•à¤¾à¤®à¤¨à¤¾à¤à¤‚!`;\n} else {\n  message = `ğŸ“Š *Monthly Report - ${name}*\\n\\n` +\n    `ğŸ’° Income: â‚¹${income.toLocaleString()} ${incomeArrow} ${incomeChange >= 0 ? '+' : ''}${incomeChange}%\\n` +\n    `ğŸ’¸ Expenses: â‚¹${expense.toLocaleString()} ${expenseArrow} ${expenseChange <= 0 ? 'Great!' : '+' + expenseChange + '%'}\\n` +\n    `ğŸ’¾ Savings: â‚¹${savings.toLocaleString()} (${savingsPercent}% of target)\\n\\n` +\n    `ğŸ“‚ *Expense Breakdown:*\\n${categoryLines || 'â€¢ No data'}\\n` +\n    `ğŸ¯ *Goals Progress:*\\n${goalsLines || 'â€¢ No goals set'}\\n` +\n    `ğŸ’ª Good luck for the new month!`;\n}\n\nreturn { phone, message };"
            },
            "id": "format-monthly",
            "name": "Format Monthly Report",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1300,
                400
            ]
        },
        {
            "parameters": {
                "operation": "send",
                "from": "+14155238886",
                "to": "={{ $json.phone }}",
                "toWhatsapp": true,
                "message": "={{ $json.message }}"
            },
            "id": "send-weekly",
            "name": "Send Weekly",
            "type": "n8n-nodes-base.twilio",
            "typeVersion": 1,
            "position": [
                1520,
                200
            ],
            "credentials": {
                "twilioApi": {
                    "id": "1",
                    "name": "Twilio account"
                }
            }
        },
        {
            "parameters": {
                "operation": "send",
                "from": "+14155238886",
                "to": "={{ $json.phone }}",
                "toWhatsapp": true,
                "message": "={{ $json.message }}"
            },
            "id": "send-monthly",
            "name": "Send Monthly",
            "type": "n8n-nodes-base.twilio",
            "typeVersion": 1,
            "position": [
                1520,
                400
            ],
            "credentials": {
                "twilioApi": {
                    "id": "1",
                    "name": "Twilio account"
                }
            }
        }
    ],
    "connections": {
        "Weekly (Sunday 8PM)": {
            "main": [
                [
                    {
                        "node": "Get Users (Weekly)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Monthly (1st, 8PM)": {
            "main": [
                [
                    {
                        "node": "Get Users (Monthly)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Users (Weekly)": {
            "main": [
                [
                    {
                        "node": "Prep Weekly",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Users (Monthly)": {
            "main": [
                [
                    {
                        "node": "Prep Monthly",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prep Weekly": {
            "main": [
                [
                    {
                        "node": "Loop Weekly",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prep Monthly": {
            "main": [
                [
                    {
                        "node": "Loop Monthly",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Loop Weekly": {
            "main": [
                [
                    {
                        "node": "Get Weekly Report",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "Loop Monthly": {
            "main": [
                [
                    {
                        "node": "Get Monthly Report",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "Get Weekly Report": {
            "main": [
                [
                    {
                        "node": "Format Weekly Report",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Monthly Report": {
            "main": [
                [
                    {
                        "node": "Format Monthly Report",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Weekly Report": {
            "main": [
                [
                    {
                        "node": "Send Weekly",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Monthly Report": {
            "main": [
                [
                    {
                        "node": "Send Monthly",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Weekly": {
            "main": [
                [
                    {
                        "node": "Loop Weekly",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send Monthly": {
            "main": [
                [
                    {
                        "node": "Loop Monthly",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "settings": {
        "executionOrder": "v1",
        "timezone": "Asia/Kolkata"
    },
    "staticData": null,
    "tags": [],
    "triggerCount": 2,
    "updatedAt": "2026-01-07T22:00:00.000Z",
    "versionId": "1"
}