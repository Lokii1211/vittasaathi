{
    "name": "MoneyViya Advanced Agent Automation v4.0",
    "meta": {
        "description": "Complete N8N workflow for WhatsApp Financial Agent - Morning Reminders, Evening Checkout, Weekly Reports, Investment Alerts",
        "version": "4.0.0"
    },
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "triggerAtHour": 6,
                            "triggerAtMinute": 0
                        }
                    ]
                }
            },
            "name": "6 AM Morning Trigger",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [
                100,
                100
            ],
            "id": "morning-trigger"
        },
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "triggerAtHour": 20,
                            "triggerAtMinute": 0
                        }
                    ]
                }
            },
            "name": "8 PM Evening Trigger",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [
                100,
                300
            ],
            "id": "evening-trigger"
        },
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "weeks",
                            "triggerAtDay": [
                                0
                            ],
                            "triggerAtHour": 10
                        }
                    ]
                }
            },
            "name": "Sunday Weekly Trigger",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [
                100,
                500
            ],
            "id": "weekly-trigger"
        },
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "triggerAtHour": 9,
                            "triggerAtMinute": 30
                        }
                    ]
                }
            },
            "name": "9:30 AM Market Update",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [
                100,
                700
            ],
            "id": "market-trigger"
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{$env.BACKEND_URL || 'https://moneyviya.up.railway.app'}}/api/users/active",
                "options": {
                    "timeout": 30000
                }
            },
            "name": "Get Active Users",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                350,
                300
            ],
            "id": "get-users"
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {
                    "reset": false
                }
            },
            "name": "Process Each User",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                550,
                300
            ],
            "id": "split-users"
        },
        {
            "parameters": {
                "conditions": {
                    "string": [
                        {
                            "value1": "={{$json.onboarding_complete}}",
                            "value2": "true"
                        }
                    ]
                }
            },
            "name": "Filter Active Users",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                750,
                300
            ],
            "id": "filter-active"
        },
        {
            "parameters": {
                "jsCode": "const user = $input.item.json;\nconst hour = new Date().getHours();\nconst name = user.name || 'Friend';\nconst dailyBudget = user.daily_budget || 500;\nconst dailyTarget = user.daily_target || 200;\n\nconst motivations = [\n    'ğŸ’ª \"Every rupee saved is a step closer to your dream!\"',\n    'ğŸŒŸ \"Small daily savings create big future wealth!\"',\n    'ğŸ”¥ \"Consistency beats intensity. You got this!\"',\n    'âœ¨ \"Today is a new opportunity to build your future!\"'\n];\n\nconst tips = [\n    'Pack lunch today to save â‚¹100!',\n    'Compare prices before buying anything.',\n    'Avoid impulse purchases - wait 24 hours.',\n    'Use public transport when possible.'\n];\n\nconst motivation = motivations[Math.floor(Math.random() * motivations.length)];\nconst tip = tips[Math.floor(Math.random() * tips.length)];\n\nconst message = `â˜€ï¸ *Good Morning, ${name}!*\n\nğŸ“… *Today's Financial Plan:*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° Daily Budget: â‚¹${dailyBudget}\nğŸ¯ Savings Target: â‚¹${dailyTarget}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${motivation}\n\nğŸ’¡ *Tip:* ${tip}\n\n*Track expenses:* Just text \"spent 50 on tea\"\n*Log income:* Text \"earned 500 from work\"`;\n\nreturn {\n    phone: user.phone,\n    message: message,\n    type: 'morning'\n};"
            },
            "name": "Generate Morning Message",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1000,
                100
            ],
            "id": "gen-morning"
        },
        {
            "parameters": {
                "jsCode": "const user = $input.item.json;\nconst name = user.name || 'Friend';\nconst todayIncome = user.today_income || 0;\nconst todayExpenses = user.today_expenses || 0;\nconst net = todayIncome - todayExpenses;\nconst target = user.target_amount || 100000;\nconst progress = user.goal_progress || 0;\n\nlet comparison = '';\nif (net > 0) {\n    comparison = `âœ… Great! You saved â‚¹${net} today!`;\n} else if (net === 0) {\n    comparison = 'â– Break-even day. Let\\'s save tomorrow!';\n} else {\n    comparison = `âš ï¸ Overspent by â‚¹${Math.abs(net)}. Let\\'s plan better!`;\n}\n\nconst filled = Math.floor(progress / 10);\nconst progressBar = 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(10 - filled);\n\nconst advice = [\n    'ğŸ’¡ Review your spending categories weekly!',\n    'ğŸ’¡ Set aside savings first thing in the morning!',\n    'ğŸ’¡ Every small expense adds up - track them all!',\n    'ğŸ’¡ Consider meal prepping to save on food costs!'\n][Math.floor(Math.random() * 4)];\n\nconst today = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });\n\nconst message = `ğŸŒ™ *Daily Closing - ${today}*\n\nğŸ“Š *Today's Summary:*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’µ Income: â‚¹${todayIncome}\nğŸ’¸ Expenses: â‚¹${todayExpenses}\nğŸ’° Net: â‚¹${net}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${comparison}\n\nğŸ¯ *Goal Progress:*\n${progressBar} ${progress}%\n\n${advice}\n\n*Is this complete?* Reply Yes/No\nOr add: \"Also spent 100 on...\"`;\n\nreturn {\n    phone: user.phone,\n    message: message,\n    type: 'evening'\n};"
            },
            "name": "Generate Evening Message",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1000,
                300
            ],
            "id": "gen-evening"
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{$env.BACKEND_URL || 'https://moneyviya.up.railway.app'}}/reports/{{$json.phone}}/weekly-comparison",
                "options": {}
            },
            "name": "Fetch Weekly Report",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1000,
                500
            ],
            "id": "fetch-weekly"
        },
        {
            "parameters": {
                "jsCode": "const user = $input.item.json;\nconst name = user.name || 'Friend';\n\n// Simulated market data (in production, fetch from API)\nconst marketMoods = ['Bullish ğŸ‚', 'Bearish ğŸ»', 'Neutral ğŸ˜', 'Volatile âš¡'];\nconst sectors = [\n    { name: 'Green Energy ğŸŒ¿', trend: 'High Growth' },\n    { name: 'Banking ğŸ¦', trend: 'Stable' },\n    { name: 'IT & Tech ğŸ’»', trend: 'Recovering' },\n    { name: 'Defence ğŸ›¡ï¸', trend: 'Booming' }\n];\n\nconst mood = marketMoods[Math.floor(Math.random() * marketMoods.length)];\nconst sector = sectors[Math.floor(Math.random() * sectors.length)];\n\nlet actionAdvice = '';\nif (mood.includes('Bullish')) {\n    actionAdvice = 'Good time to invest! Consider increasing SIP.';\n} else if (mood.includes('Bearish')) {\n    actionAdvice = 'Stay calm. Continue SIP for rupee cost averaging.';\n} else {\n    actionAdvice = 'Perfect time for systematic investments!';\n}\n\nconst message = `ğŸ“ˆ *Good Morning Market Update!*\n\n*Market Mood:* ${mood}\n*Hot Sector:* ${sector.name} (${sector.trend})\n\nğŸ’¡ *Today's Strategy:*\n${actionAdvice}\n\nğŸ¯ *Quick Tips:*\nâ€¢ SIP is always a smart choice\nâ€¢ Don't panic sell in dips\nâ€¢ Review portfolio monthly\n\nType \"invest\" for personalized advice!`;\n\nreturn {\n    phone: user.phone,\n    message: message,\n    type: 'market'\n};"
            },
            "name": "Generate Market Update",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1000,
                700
            ],
            "id": "gen-market"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{$env.BACKEND_URL || 'https://moneyviya.up.railway.app'}}/api/send-message",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "phone",
                            "value": "={{$json.phone}}"
                        },
                        {
                            "name": "message",
                            "value": "={{$json.message}}"
                        }
                    ]
                },
                "options": {
                    "timeout": 30000
                }
            },
            "name": "Send WhatsApp Message",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                1250,
                300
            ],
            "id": "send-whatsapp"
        },
        {
            "parameters": {
                "jsCode": "const input = $input.item.json;\nconst report = input.report || input;\n\nlet message = '';\nif (typeof report === 'string') {\n    message = report;\n} else {\n    const name = report.name || input.name || 'Friend';\n    const income = report.weekly_income || report.income || 0;\n    const expenses = report.weekly_expenses || report.expenses || 0;\n    const saved = income - expenses;\n    const comparison = report.comparison || 'Keep going!';\n    \n    message = `ğŸ“Š *Weekly Report for ${name}*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ’µ *Total Income:* â‚¹${income.toLocaleString('en-IN')}\nğŸ’¸ *Total Expenses:* â‚¹${expenses.toLocaleString('en-IN')}\nğŸ’° *Net Saved:* â‚¹${saved.toLocaleString('en-IN')}\n\nğŸ“ˆ *vs Last Week:*\n${comparison}\n\nğŸ¯ Keep tracking!\nğŸ“… Next report: Next Sunday\n\nğŸ’ª Great job this week!`;\n}\n\nreturn {\n    phone: input.phone,\n    message: message,\n    type: 'weekly'\n};"
            },
            "name": "Format Weekly Report",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1200,
                500
            ],
            "id": "format-weekly"
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "status",
                            "value": "Messages sent successfully"
                        }
                    ]
                }
            },
            "name": "Log Success",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3,
            "position": [
                1450,
                300
            ],
            "id": "log-success"
        }
    ],
    "connections": {
        "6 AM Morning Trigger": {
            "main": [
                [
                    {
                        "node": "Get Active Users",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "8 PM Evening Trigger": {
            "main": [
                [
                    {
                        "node": "Get Active Users",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Sunday Weekly Trigger": {
            "main": [
                [
                    {
                        "node": "Get Active Users",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "9:30 AM Market Update": {
            "main": [
                [
                    {
                        "node": "Get Active Users",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Active Users": {
            "main": [
                [
                    {
                        "node": "Process Each User",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Process Each User": {
            "main": [
                [
                    {
                        "node": "Filter Active Users",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Process Each User",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter Active Users": {
            "main": [
                [
                    {
                        "node": "Generate Morning Message",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Generate Evening Message",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Fetch Weekly Report",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Generate Market Update",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "Generate Morning Message": {
            "main": [
                [
                    {
                        "node": "Send WhatsApp Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Evening Message": {
            "main": [
                [
                    {
                        "node": "Send WhatsApp Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Weekly Report": {
            "main": [
                [
                    {
                        "node": "Format Weekly Report",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Weekly Report": {
            "main": [
                [
                    {
                        "node": "Send WhatsApp Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Market Update": {
            "main": [
                [
                    {
                        "node": "Send WhatsApp Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send WhatsApp Message": {
            "main": [
                [
                    {
                        "node": "Log Success",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1",
        "saveExecutionProgress": true,
        "saveManualExecutions": true
    },
    "staticData": null,
    "tags": [
        "finance",
        "whatsapp",
        "automation",
        "agent"
    ]
}